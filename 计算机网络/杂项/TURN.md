TURN（Traversal Using Relays around NAT）是一种网络协议，主要用于解决在一些严苛的网络环境中，==STUN 协议无法建立点对点（P2P）连接的问题。你可以把 TURN 服务器想象成一个**“网络中继站”**。==

### 为什么需要 TURN？

我们知道，大多数设备都位于 NAT（网络地址转换）后面的私有网络中。STUN 协议能够帮助设备发现自己的公网地址，从而建立直接的 P2P 连接。

然而，对于最严格的 **Symmetric NAT** 类型，STUN 无法有效工作。Symmetric NAT 会为每个新的连接分配一个全新的公网端口，==这意味着 STUN 服务器给你的地址，与你和对端通信时使用的地址是不同的。因此，即使你把这个地址告诉对方，对方也无法通过这个地址直接联系你==。

在这种情况下，点对点通信是不可能的。TURN 的作用就是为这些“不兼容”的设备提供一种替代方案。

### TURN 的工作原理

TURN 的核心思想是**放弃点对点直连，转而通过一个中继服务器进行数据转发**。

1. **分配地址**：客户端 A 和客户端 B 都无法直接联系对方。==它们各自向一个公网上的 TURN 服务器发送请求，要求服务器为它们分配一个公网地址。==
    
2. **数据转发**：TURN 服务器会为每个客户端分配一个中继地址。
    
3. **开始通信**：当客户端 A 想要向客户端 B 发送数据时，==它不是直接发送给 B，而是将数据发送到 TURN 服务器为 B 分配的那个中继地址上。==
    
4. **服务器中转**：TURN 服务器收到数据后，会将数据包从那个中继地址转发给客户端 B。反之亦然。

### TURN 的优点和缺点

**优点：**

- **高兼容性**：==TURN 几乎可以解决所有 NAT 类型的问题，包括最严格的 Symmetric NAT，保证了通信的成功率。==
    
- **可靠性高**：它提供了一个稳定的数据中继通道，可以确保数据包的到达。
    

**缺点：**

- **高延迟**：数据需要经过 TURN 服务器中转，这比点对点直连多了一个跳跃点，会增加延迟。==这对于对实时性要求高的应用（如视频会议）是一个挑战。==
    
- **高成本**：TURN 服务器需要处理和转发大量数据，这会消耗大量的服务器带宽和计算资源。==这使得运行一个 TURN 服务器比运行一个 STUN 服务器昂贵得多==。
    

### TURN 与 STUN/ICE 的关系

- **STUN**：是**第一选择**。它通过尝试建立点对点连接来最小化延迟和成本。
    
- **TURN**：是**备用方案**。当 STUN 失败时，**ICE（Interactive Connectivity Establishment）**框架会自动尝试使用 TURN 作为中继来建立连接。
    

在 WebRTC 等 P2P 通信框架中，通常会先尝试 STUN，如果无法成功“穿透”，才会退而求其次使用 TURN。这种多层级策略保证了连接的成功率，同时尽可能地保持低延迟和低成本。