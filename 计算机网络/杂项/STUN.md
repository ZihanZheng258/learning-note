STUN 的全称是 **Session Traversal Utilities for NAT**，中文是==**会话穿越应用程序编程接口**。它是一种网络协议，主要用于帮助设备在 NAT（网络地址转换）环境中发现自己的公网 IP 地址和端口，从而为**点对点（P2P）通信**做准备。==

你可以把 STUN 想象成一个**“网络地址侦察兵”**。

- **你的设备**：就像一个躲在堡垒（内网）里的小兵。它只知道堡垒内部的地址。
    
- **STUN 服务器**：==一个位于公共网络上的、可以被任何人访问的“情报站”。==
    
- **STUN 的作用**：小兵向情报站发送一个请求，情报站会回复说：“我看到你发来的请求来自这个公网 IP 地址和这个端口。”小兵通过这个回复，就知道了自己在外部世界的地址。
    

### 为什么需要 STUN？

大多数设备都处于一个**私有网络（内网）**中，拥有一个私有 IP 地址（如 `192.168.1.100`）。这些内网通过一个叫做**路由器**的设备连接到公共互联网。路由器会使用 **NAT（网络地址转换）**技术，将所有内网设备的请求都伪装成来自同一个**公网 IP 地址**。

这带来一个问题：当两个设备想直接进行点对点通信时，它们只知道彼此的私有 IP 地址，无法直接联系。==它们需要知道对方的公网 IP 地址和端口，才能跨越 NAT 的障碍。==

STUN 的核心任务就是帮助设备获取这个公网地址信息。

### STUN 的工作原理

STUN 的工作流程非常简单：

1. **客户端请求**：位于内网的设备（客户端）向一个公网上的 STUN 服务器发送一个请求。
    
2. **服务器响应**：==STUN 服务器收到请求后，会记录下请求的来源 IP 和端口，然后将这些信息封装在响应中，发回给客户端。==
    
3. **客户端获取**：客户端收到响应后，就知道了自己在公网上的 IP 和端口，这个地址可以被其他客户端直接访问。
    

### STUN 的局限性

虽然 STUN 很有效，但它并不能解决所有 NAT 类型的问题。

- **Full Cone NAT** 和 **Restrict NAT**：STUN 在这些类型的 NAT 下工作得很好。
    
- **Symmetric NAT**：这是 STUN 的一个主要挑战。Symmetric NAT 会为每个新的连接分配一个新的端口。==这意味着 STUN 服务器给你的公网地址，不一定能被你想通信的那个对端设备使用。==
    

### STUN 与 TURN/ICE 的关系

为了解决 STUN 的局限性，出现了更复杂的协议：

- **TURN（Traversal Using Relays around NAT）**：当 STUN 失败时，TURN 服务器会作为一个**中继**。两个客户端都将数据发送给 TURN 服务器，再由 TURN 服务器转发给对方。这虽然解决了所有 NAT 类型的问题，但牺牲了点对点的优势，增加了延迟和服务器成本。
    
- **ICE（Interactive Connectivity Establishment）**：ICE 是一套更高级的框架，它会尝试所有可能的连接方式（先尝试点对点，如果失败，再尝试 TURN 中继），以确保通信能够成功。STUN 和 TURN 都是 ICE 框架的一部分。
    

总而言之，**STUN 是一种用于获取公网 IP 和端口的简单协议，是实现点对点通信的第一步**。