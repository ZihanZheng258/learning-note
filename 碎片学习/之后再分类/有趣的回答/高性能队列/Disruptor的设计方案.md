
Disruptor通过以下设计来解决队列速度慢的问题：

- 环形数组结构

==为了避免垃圾回收，采用数组而非链表==。同时，数组对处理器的缓存机制更加友好。

- 元素位置定位

数组长度2^n，通过位运算，加快定位的速度。下标采取递增的形式。不用担心index溢出的问题==。index是long类型，即使100万QPS的处理速度，也需要30万年才能用完。==

- 无锁设计

每个生产者或者消费者线程，==会先申请可以操作的元素在数组中的位置，申请到之后，直接在该位置写入或者读取数据。==

下面忽略数组的环形结构，==介绍一下如何实现无锁设计。整个过程通过原子变量CAS，保证操作的线程安全==。

### 一个生产者

**写数据**

生产者单线程写数据的流程比较简单：

1. 申请写入m个元素；
2. 若是有m个元素可以入，则返回最大的序列号。这儿主要判断是否会覆盖未读的元素；
3. 若是返回的正确，则生产者开始写入元素。

![[Pasted image 20250707172304.png]]